<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE fileformat>
<fileformat>

	<xi:include href="../ovl_base/ovl_base.xml" xmlns:xi="http://www.w3.org/2001/XInclude" xpointer="xpointer(*/*)" />

    <struct name="WmetasbRoot" inherit="MemStruct">
        <field name="levels" type="ArrayPointer" template="JWE2WmetasbMain" arg="count" vercond="(#JWE2# #OR# is_PC2)"/>
        <field name="levels" type="ArrayPointer" template="WmetasbMain" arg="count" vercond="!(#JWE2# #OR# is_PC2)"/>
        <field name="count" type="uint64" />
    </struct>

    <struct name="JWE2WmetasbMain" inherit="MemStruct">
        JWE2, PC2: 32 bytes
        <field name="block_name" type="Pointer" template="ZString"/>
        <field name="events" type="ArrayPointer" template="EventEntry" arg="events_count" />
        <field name="events_count" type="uint" />
        <field name="hash" type="uint" />
        <field name="unk1" type="uint" />
        <field name="unk2" type="uint" />
    </struct>

    <struct name="WmetasbMain" inherit="MemStruct">
		# JWE, PC: 112 bytes
		# PZ, JWE2: 32 bytes
        todo - versioning that catches JWE, needs wmetasb version from fileentry
        <field name="hash" type="uint" />
        <field name="unk" type="uint" />
        <field name="block_name" type="Pointer" template="ZString"/>
        <field name="media_name" type="Pointer" template="ZString" until="18"/>
        <field name="bnk_name" type="Pointer" template="ZString" until="18"/>
        <field name="events" type="ArrayPointer" template="EventEntry" arg="events_count" />
        <field name="events_count" type="uint64" />
        <field name="hashes" type="ArrayPointer" template="uint" arg="hashes_count" until="18" />
        <field name="hashes_count" type="uint64" until="18" />
        <field name="media" type="ArrayPointer" template="MediaEntry" until="18" arg="media_count"/>
        <field name="media_count" type="uint64" until="18"/>
        <field name="unused 2" type="Pointer" until="18" />
        <field name="unused 3" type="Pointer" until="18" />
        <field name="unused 4" type="Pointer" until="18" />
        <field name="unused 5" type="Pointer" until="18" />
    </struct>

    <struct name="MediaEntry" inherit="MemStruct">
        PC: 32 bytes
        <field name="hash" type="uint" />
        <field name="zero" type="uint" />
        <field name="block_name" type="Pointer" template="ZString"/>
        <field name="wav_name" type="Pointer" template="ZString"/>
        <field name="wem_name" type="Pointer" template="ZString"/>
    </struct>

    <struct name="EventEntry" inherit="MemStruct">
        PC: 56 bytes
        JWE2: 40 bytes
        PC2: 44 bytes
        # todo - improve versioning
        <field name="hash" type="uint" />
        <field name="zero" type="uint" />
        <field name="block_name" type="Pointer" template="ZString" until="18"/>
        <field name="zero2" type="ushort" until="18" />
        <field name="size" type="ushort" until="18" /> <!-- maybe -->
        <field name="flag 0" type="uint" />
        <field name="flag 1" type="uint" />
        <field name="flag 2" type="uint" />
        <field name="zero 3" type="uint64" until="18" />
        <field name="flag 3" type="uint" until="18" />

        <field name="hash b" type="uint" />
        <field name="hash c" type="uint" /> <!-- fnv1 of lowercase event name -->
        <field name="zero 4" type="uint" />

        <field name="u2" type="uint" since="19"/>
        <field name="u1" type="uint" since="19" />
        <field name="u4" type="uint" since="19" vercond="is_PC2"/>
    </struct>

</fileformat>
