#!/usr/bin/env python
import subprocess
import datetime


def should_increment():
    TRACKED_FOLDERS = [
        "codegen",
        "constants",
        "generated",
        "source",
        "modules",
        "utils",
        "dumps",
        "sql_commands",
        "gui",
        "plugin",
    ]
    changed = subprocess.check_output(
        ["git", "diff", "--name-only", "--cached"], text=True
    )
    for path in changed.splitlines():
        path = path.split("/")
        if path[0] in TRACKED_FOLDERS:
            return True
        elif len(path) == 1:
            if path[0].endswith(".py"):
                return True
            if path[0] == "pyproject.toml":
                return True


def main():
    if should_increment():
        # retrieve lastest commit hash and time
        last_commit = subprocess.check_output(
            ["git", "log", r"--pretty=format:%h - %cd", "-1"], text=True
        )
        commit_hash, commit_time = last_commit.split(" - ")
        # simplify the commit time to be useful as a human readable version
        commit_date = datetime.datetime.strptime(commit_time, "%a %b %d %H:%M:%S %Y %z")
        utc_dt = commit_date.astimezone(datetime.timezone.utc)
        date_version_str = utc_dt.strftime("%Y.%m.%d")
        # retrieve version from pyproject.toml and update it
        project = "pyproject.toml"
        with open(project, "r") as fproj:
            contents = fproj.readlines()
        with open(project, "w") as fproj:
            for line in contents:
                if line.startswith('version = "'):
                    fproj.write(f'version = "{date_version_str}"\n')
                else:
                    fproj.write(line)

        # write version file used by logging
        version_file = "__version__.py"
        with open(version_file, "w") as file:
            file.writelines(
                [
                    "# this file is auto-generated by the pre-commit hook increment_version.py\n",
                    f'VERSION = "{date_version_str}"\n',
                    f'COMMIT_HASH = "{commit_hash}"\n',
                    f'COMMIT_TIME = "{commit_time}"\n',
                ]
            )

        # override static version of blender plugin in __init__.py
        init_file = "__init__.py"
        date_version_str_int = tuple(int(x) for x in date_version_str.split("."))
        with open(init_file, "r") as file:
            lines = file.readlines()
        with open(init_file, "w") as file:
            for line in lines:
                if '"version":' in line:
                    file.write(f'    "version": {date_version_str_int},\n')
                else:
                    file.write(line)

        return subprocess.run(["git", "add", version_file, init_file, project]).returncode


if __name__ == "__main__":
    SystemExit(main())
